# GitLab CI: Test, Lint, and Sync
# Rust-native pipeline — no Python except version-check

include:
  - project: 'arktechnwa/ci-utils'
    file: '/templates/failure-issue.yml'

stages:
  - test
  - lint
  - sync

variables:
  GITHUB_REPO: "git@github.com:ArkTechNWA/zsh-tool.git"
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"

# Cache Rust build artifacts between jobs
cache:
  key: rust-${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/registry/
    - .cargo/git/
    - zsh-tool-rs/target/

# =============================================================================
# Test Stage
# =============================================================================

test:
  stage: test
  image: rust:slim
  before_script:
    - apt-get update && apt-get install -y zsh pkg-config
  script:
    - cd zsh-tool-rs
    - cargo test -- --test-threads=1
  rules:
    - if: $CI_COMMIT_BRANCH  # Only branches - tags inherit commit status

# =============================================================================
# Lint Stage
# =============================================================================

version-check:
  stage: lint
  image: python:3.13-slim
  extends: .failure-issue
  script:
    - python scripts/version-check.py
  rules:
    - if: $CI_COMMIT_BRANCH  # All branches

clippy:
  stage: lint
  image: rust:slim
  script:
    - cd zsh-tool-rs
    - rustup component add clippy
    - cargo clippy -- -D warnings
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH  # Only branches

# =============================================================================
# Sync Stage (GitHub Mirror)
# =============================================================================

sync-to-github:
  stage: sync
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache git openssh-client
    - mkdir -p ~/.ssh
    - echo "$GITHUB_DEPLOY_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
    - git config --global user.email "claude@arktechnwa.com"
    - git config --global user.name "Johnny5 CI"
  script:
    - git remote add github $GITHUB_REPO || git remote set-url github $GITHUB_REPO
    - git fetch --unshallow origin || true
    - git fetch origin --tags --force
    - |
      # Compare branch HEAD
      GITHUB_HEAD=$(git ls-remote github refs/heads/master 2>/dev/null | awk '{print $1}')
      LOCAL_HEAD=$(git rev-parse HEAD)
      # Compare tags
      LOCAL_TAGS=$(git tag -l | sort)
      GITHUB_TAGS=$(git ls-remote --tags github 2>/dev/null | awk '{print $2}' | sed 's|refs/tags/||' | grep -v '\^{}' | sort)
      if [ "$GITHUB_HEAD" = "$LOCAL_HEAD" ] && [ "$LOCAL_TAGS" = "$GITHUB_TAGS" ]; then
        echo "✓ GitHub already in sync — no diff, skipping"
      else
        if [ "$GITHUB_HEAD" != "$LOCAL_HEAD" ]; then
          echo "Branch diff: GitHub=${GITHUB_HEAD:-<none>} Local=$LOCAL_HEAD"
          git push github HEAD:refs/heads/master --force
          echo "✓ Pushed branch"
        fi
        if [ "$LOCAL_TAGS" != "$GITHUB_TAGS" ]; then
          echo "Tag diff detected"
          git push github --tags --force
          echo "✓ Pushed tags"
        fi
        echo "✓ Synced to GitHub"
      fi
